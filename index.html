<!DOCTYPE html>
<html lang="sv">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Nedräkning till preskription</title>
    <style>
        /* Grundinställningar */
        body { 
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; 
            background: #f4f4f9; 
            margin: 0; 
            padding: 10px; /* Mindre padding för mobil */
        }
        .container { 
            max-width: 800px; 
            background: white; 
            padding: 15px; 
            border-radius: 8px; 
            margin: 0 auto; 
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        h1 { 
            text-align: center; 
            color: #2c3e50; 
            font-size: 1.5em; /* Lite mindre rubrik */
            margin-top: 0;
        }
        p {
            font-size: 0.9em;
            color: #666;
            text-align: center;
        }

        /* Tabell-design */
        table { 
            width: 100%; 
            border-collapse: collapse; 
            margin-top: 15px; 
            font-size: 14px; /* Standardstorlek desktop */
        }
        th, td { 
            text-align: left; 
            padding: 10px; 
            border-bottom: 1px solid #ddd; 
        }
        th { background-color: #f8f9fa; }

        /* Färger för status */
        .expired { color: #c0392b; font-weight: bold; font-size: 0.9em; }
        .active { color: #27ae60; font-weight: bold; }

        /* MOBILANPASSNING */
        @media (max-width: 600px) {
            body { padding: 5px; }
            .container { padding: 10px; }
            
            table { 
                font-size: 11px; /* Mycket mindre text på mobil */
            }
            th, td { 
                padding: 6px 2px; /* Mycket mindre luft i cellerna */
            }
            
            /* Tvinga kolumnerna att inte bli för breda */
            th:nth-child(1), td:nth-child(1) { width: 15%; text-align: center; } /* Nr */
            th:nth-child(2), td:nth-child(2) { width: 25%; } /* Datum */
            th:nth-child(3), td:nth-child(3) { width: 60%; text-align: right; } /* Status */
        }

        .countdown-box {
            text-align: center;
            margin-bottom: 16px;
            padding: 14px 12px;
            background: #fff4f4;
            border: 1px solid #f2c0c0;
            border-radius: 10px;
            box-shadow: inset 0 1px 0 rgba(255,255,255,0.6);
        }
        .countdown-label {
            font-size: 0.95em;
            color: #2c3e50;
            letter-spacing: 0.3px;
            margin-bottom: 6px;
            text-transform: uppercase;
            font-weight: 600;
        }
        #countdown-timer {
            font-weight: 800;
            color: #c0392b;
            font-size: clamp(2rem, 6vw, 3.5rem);
            letter-spacing: 1px;
            display: inline-flex;
            flex-wrap: wrap;
            gap: 10px;
            justify-content: center;
            align-items: center;
            font-family: "SFMono-Regular", Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
        }
        .time-chip {
            display: inline-flex;
            align-items: baseline;
            gap: 4px;
            padding: 6px 10px;
            background: white;
            border-radius: 8px;
            box-shadow: 0 1px 2px rgba(0,0,0,0.08);
            border: 1px solid #f2c0c0;
        }
        .time-chip small {
            font-size: 0.55em;
            color: #a33b3b;
            letter-spacing: 0.5px;
        }

        #debug-msg { color: red; font-weight: bold; text-align: center; display: none; }
    </style>
</head>
<body>

<div class="container">
    <h1>Kampen mot klockan</h1>
    <p>Översikt över åtalspunkternas preskriptionsdatum.</p>

    <div class="countdown-box">
        <div id="countdown-label" class="countdown-label">Åtalspunkt --/--</div>
        <div id="countdown-timer">--</div>
    </div>
    
    <div id="debug-msg">Laddar data...</div>

    <table id="caseTable">
        <thead>
            <tr>
                <th>Nr</th>
                <th>Datum</th>
                <th style="text-align: right;">Status</th>
            </tr>
        </thead>
        <tbody></tbody>
    </table>
</div>

<script>
try {
    const cases = [
        { id: "1", date: "2023-01-08" },
        { id: "2", date: "2023-01-17" },
        { id: "3", date: "2023-01-27" },
        { id: "4", date: "2023-02-10" },
        { id: "5", date: "2023-02-26" },
        { id: "6", date: "2023-03-02" },
        { id: "7", date: "2023-03-11" },
        { id: "8", date: "2023-03-27" },
        { id: "9", date: "2023-03-29" },
        { id: "10", date: "2023-04-11" },
        { id: "11 (A)", date: "2023-04-04" },
        { id: "11 (B)", date: "2023-05-21" },
        { id: "12", date: "2023-04-18" },
        { id: "13", date: "2023-04-24" },
        { id: "14", date: "2023-04-26" },
        { id: "15", date: "2023-05-03" },
        { id: "16", date: "2023-05-08" },
        { id: "17", date: "2023-05-23" },
        { id: "18", date: "2023-06-19" },
        { id: "19", date: "2023-06-22" },
        { id: "20", date: "2023-06-25" },
        { id: "21", date: "2023-07-12" },
        { id: "22", date: "2023-07-17" },
        { id: "23", date: "2023-07-23" },
        { id: "24", date: "2023-08-03" },
        { id: "25", date: "2023-08-12" },
        { id: "27", date: "2023-08-17" },
        { id: "28", date: "2023-09-07" },
        { id: "29", date: "2023-12-06" },
        { id: "30", date: "2024-01-13" },
        { id: "31", date: "2024-01-25" }
    ];

    const tableBody = document.querySelector("#caseTable tbody");
    const countdownLabel = document.getElementById("countdown-label");
    const countdownTimer = document.getElementById("countdown-timer");
    const totalCases = cases.length;

    function toLocalDate(dateStr) {
        const [y, m, d] = dateStr.split("-").map(Number);
        return new Date(y, m - 1, d, 0, 0, 0, 0); // Lokal midnatt
    }

    const casesWithPresk = cases.map(c => {
        const evtDate = toLocalDate(c.date);
        const preskDate = new Date(evtDate);
        preskDate.setFullYear(evtDate.getFullYear() + 2);
        preskDate.setDate(preskDate.getDate() + 1); // Preskriberas 00:00 dagen efter 2-årsdagen
        return { ...c, preskDate };
    });

    const today = new Date();
    today.setHours(0,0,0,0);

    const sortedCases = [...casesWithPresk].sort((a, b) => a.preskDate - b.preskDate);

    sortedCases.forEach(c => {

        const diffTime = c.preskDate - today;
        const days = Math.floor(diffTime / (1000 * 60 * 60 * 24));
        
        const tr = document.createElement("tr");
        
        // Kortare text om preskriberad för att spara plats
        let status = days <= 0 
            ? '<span class="expired">PRESKRIBERAD</span>' 
            : '<span class="active">' + days + ' dagar</span>';

        // Högerställd status för snyggare layout på mobil
        tr.innerHTML = '<td style="text-align:center">' + c.id + '</td>' +
                       '<td>' + c.date + '</td>' +
                       '<td style="text-align:right">' + status + '</td>';
        tableBody.appendChild(tr);
    });

    function findNextPreskription() {
        const now = new Date();
        const upcoming = casesWithPresk
            .map(c => ({ ...c, diff: c.preskDate - now }))
            .filter(c => c.diff > 0)
            .sort((a, b) => a.diff - b.diff);
        return upcoming[0] || null;
    }

    function formatDurationParts(ms) {
        if (ms <= 0) return [{ value: 0, label: "s" }];

        const totalSeconds = Math.floor(ms / 1000);
        if (totalSeconds < 60) return [{ value: totalSeconds, label: "s" }];

        const SECONDS_IN_MINUTE = 60;
        const SECONDS_IN_HOUR = 60 * SECONDS_IN_MINUTE;
        const SECONDS_IN_DAY = 24 * SECONDS_IN_HOUR;
        const SECONDS_IN_WEEK = 7 * SECONDS_IN_DAY;
        const SECONDS_IN_MONTH = 30 * SECONDS_IN_DAY; // Approximation funkar bra här

        let remaining = totalSeconds;
        const months = Math.floor(remaining / SECONDS_IN_MONTH);
        remaining %= SECONDS_IN_MONTH;
        const weeks = Math.floor(remaining / SECONDS_IN_WEEK);
        remaining %= SECONDS_IN_WEEK;
        const days = Math.floor(remaining / SECONDS_IN_DAY);
        remaining %= SECONDS_IN_DAY;
        const hours = Math.floor(remaining / SECONDS_IN_HOUR);
        remaining %= SECONDS_IN_HOUR;
        const minutes = Math.floor(remaining / SECONDS_IN_MINUTE);
        const seconds = remaining % SECONDS_IN_MINUTE;

        const parts = [];
        if (months) parts.push({ value: months, label: "mån" });
        if (weeks) parts.push({ value: weeks, label: "v" });
        if (days) parts.push({ value: days, label: "d" });
        if (hours || parts.length) parts.push({ value: hours, label: "h" });
        if (minutes || parts.length) parts.push({ value: minutes, label: "m" });
        parts.push({ value: seconds, label: "s" });

        return parts;
    }

    function renderCountdown(ms) {
        countdownTimer.innerHTML = "";
        const parts = formatDurationParts(ms);
        parts.forEach(part => {
            const span = document.createElement("span");
            span.className = "time-chip";
            span.innerHTML = `<span>${part.value}</span><small>${part.label}</small>`;
            countdownTimer.appendChild(span);
        });
    }

    function updateCountdown() {
        const next = findNextPreskription();
        if (!next) {
            countdownLabel.textContent = "Alla åtalspunkter preskriberade";
            countdownTimer.textContent = "--";
            return;
        }

        countdownLabel.textContent = `Åtalspunkt ${next.id}/${totalCases}`;

        const diff = next.preskDate - new Date();
        renderCountdown(diff);
    }

    updateCountdown();
    setInterval(updateCountdown, 1000);

} catch (err) {
    document.getElementById("debug-msg").style.display = "block";
    document.getElementById("debug-msg").innerText = "FEL: " + err.message;
}
</script>

</body>
</html>
